# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2026
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################
name: Go Linter Fixer
# yamllint disable-line rule:truthy
on:
  issues:
    types: [labeled]
  workflow_dispatch:
permissions: read-all
jobs:
  fix-docker-build:
    name: Fix Docker Issues
    if: >
      github.event_name == 'workflow_dispatch' || (github.event.label.name == 'docker-build-issue')

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      # jscpd:ignore-start
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # 6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Run Copilot CLI to fix Docker build/runtime failures
        uses: austenstone/copilot-cli@b5945a4decc5f2662ba475a812da35661e512e81 # 2.0
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          allow-all-tools: true
          repo-token: ${{ github.actor == 'electrocucaracha[bot]' && secrets.COPILOT_TOKEN || github.token }}
          mcp-config: |
            {
              "mcpServers": {
                "github-mcp-server": {
                  "type": "http",
                  "url": "https://api.githubcopilot.com/mcp/",
                  "headers": {
                    "Authorization": "Bearer ${{ secrets.COPILOT_TOKEN }}",
                    "X-MCP-Toolsets": "*"
                  },
                  "tools": ["*"]
                }
              }
            }
          # jscpd:ignore-end
          prompt: |-
            Objective:
            Fully resolve Docker build and container runtime failures in this repository and submit a pull request.

            Execution Steps:
            1. Run: `docker build -t test .`
            2. If build succeeds, run: `docker run --rm test:latest --help`
            3. If either step fails:
               - Analyze the error output
               - Identify the failing Dockerfile instruction or runtime command
               - Apply minimal and correct fixes directly to the repository
            4. Repeat build and run steps until BOTH commands succeed.

            Requirements:
            - Do NOT ignore or bypass failures.
            - Do NOT disable Dockerfile instructions unless strictly required.
            - Do NOT introduce insecure practices (e.g., running as root unless required).
            - Keep changes minimal and production-safe.
            - Preserve intended application behavior.
            - Do NOT modify unrelated files.
            - Prefer deterministic and reproducible fixes (pin versions when appropriate).
            - Maintain multi-stage build integrity if present.

            Completion Criteria:
            The task is complete ONLY when:
            - `docker build` exits successfully
            - `docker run --rm test:latest --help` exits successfully
            - No new warnings or build errors are introduced

            Create a pull request with:
            - Title: "fix: resolve Docker build and runtime failures"
            - Body:
              Closes #${{ github.event.issue.number }}.

              Include:
              - Root cause summary
              - Files modified
              - Explanation of the fix
              - Confirmation that build and runtime now succeed

            Ensure the PR is clean, minimal, and ready for review.
